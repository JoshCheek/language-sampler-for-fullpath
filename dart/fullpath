#!/usr/bin/env dart
import "dart:io";

class Fullpath {
  List<String>      args;
  String            cwd; // there is a directory class, but it isn't useful
  Stream<List<int>> instream;
  IOSink            outstream;
  bool              help = false;
  bool              copy = false;

  Fullpath(args, this.cwd, this.instream, this.outstream) {
    this.args = new List();
    args.forEach((arg) {
      if(arg == "-h" || arg == "--help")
        help = true;
      else if(arg == "-c" || arg == "--copy")
        copy = true;
      else
        this.args.add(arg);
    });
    this.args = filterBlanks(this.args);
  }

  call() {
    if(help)
      outstream.write(helpScreen());
    else if(args.isNotEmpty)
      printPaths(args);
    else
      instream
        .map((bytes) => new String.fromCharCodes(bytes))
        .map(split)
        .toList()
        .then(flatten)
        .then(filterBlanks)
        .then(printPaths);
  }

  filterBlanks(paths) => paths.toList(growable: true)..removeWhere((s) => s.isEmpty);

  printPaths(paths) {
    printPathsToStream(paths, outstream);
    if(copy) {
      Process.start('pbcopy', []).then((process) {
        printPathsToStream(paths, process.stdin);
        process.stdin.close();
      });
    }
  }

  printPathsToStream(paths, stream) {
    if(paths.length == 1)
      stream.write(path(paths[0]));
    else
      paths.forEach((filename) => stream.write(path(filename)+"\n"));
  }

  // normalizePath
  path(filename) => (cwd + "/" + filename).toString();
  split(str) => str.split(new RegExp(r"\n"));
  flatten(lists) {
    var result = new List();
    lists.forEach((list) => result.addAll(list));
    return result;
  }

  helpScreen() => """
usage: fullpath *[relative-paths] [-c]

  Prints the fullpath of the paths
  If no paths are given as args, it will read them from stdin

  If there is only one path, the trailing newline is omitted

  The -c flag will copy the results into your pasteboard
""";
}

main(List<String> args) {
  var cwd = Directory.current.path.toString();
  new Fullpath(args, cwd, stdin, stdout)();

  // print("*** Robot Stuffs ***");
  // var r = new Robot();
}
